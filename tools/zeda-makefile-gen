#!/bin/sh

echo "# This makefile was automatically generated by zeda-makefile-gen in ZEDA."
echo "# `date` by `whoami`"

case $1 in
tools)
    cat << EOF
include ../config

BINDIR=\$(PREFIX)/bin

INSTALL=install -m 755
UNINSTALL=rm -f

CONFIGTOOL=\$(PROJNAME)-config
CONFIGGEN=\`which zeda-config-gen\`

INCLUDE=
LIB=
DEF=
LINK=-l\$(PROJNAME)

include config.tools

all: \$(CONFIGTOOL)

\$(CONFIGTOOL):
	@echo " GENERATE	" \$@
	-@rm -f \$@
	@\$(CONFIGGEN) -I "\$(INCLUDE)" -L "\$(LIB)" -D "\$(DEF)" -l "\$(LINK)" -v \$(VERSION) > \$@
install: \$(CONFIGTOOL)
	@echo " INSTALL	" \$^
	@\$(INSTALL) \$^ \$(BINDIR)
clean:
	@echo " CLEAN"
	-@rm -f *.o *~ core \$(CONFIGTOOL)
uninstall:
	@echo " UNINSTALL	" \$(CONFIGTOOL)
	@cd \$(BINDIR); \$(UNINSTALL) \$(CONFIGTOOL)
EOF
    ;;
app)
    cat << EOF
include ../config

BINDIR=\$(PREFIX)/bin

INSTALL=install -m 755
UNINSTALL=rm -f

CONFIGTOOL=\$(PROJNAME)-config
LINK=\`\$(CONFIGTOOL) -l\`

CC=gcc
EOF
    echo "CFLAGS=$2 -Wall -O3 \`\$(CONFIGTOOL) --cflags\`"
    cat << EOF
TARGET=\$(shell ls *.c | xargs -i basename {} .c | xargs)

all: \$(TARGET)

%: %.c
	@echo " CC	" $<
	@\$(CC) \$(CFLAGS) -o \$@ \$< \$(LINK)
clean:
	@echo " CLEAN"
	-@rm -f *.o *~ core \$(TARGET)
install: \$(TARGET)
ifneq (\$(TARGET),)
	@echo " INSTALL	" \$^
	@\$(INSTALL) $^ \$(BINDIR)
endif
uninstall:
ifneq (\$(TARGET),)
	@echo " UNINSTALL	" \$(TARGET)
	@cd \$(BINDIR); \$(UNINSTALL) \$(TARGET)
endif
EOF
    ;;
*)
    cat << EOF
CONFIG:=\$(shell test -e config || cp config.org config; echo config)
include \$(CONFIG)

ROOTDIR:=.
INCDIR:=\$(ROOTDIR)/include/\$(PROJNAME)
SRCDIR:=\$(ROOTDIR)/src
LIBDIR:=\$(ROOTDIR)/lib
TOOLDIR:=\$(ROOTDIR)/tools
APPDIR:=\$(ROOTDIR)/app
DOCDIR:=\$(ROOTDIR)/doc
TESTDIR:=\$(ROOTDIR)/test
SAMPLEDIR:=\$(ROOTDIR)/example

all: library devtools
library:
	@cd \$(SRCDIR); make
devtools:
	@cd \$(TOOLDIR); make
autotest:
	@cd \$(TESTDIR); ./test.sh
doc:
	@cd \$(DOCDIR); make
clean:
	-@rm -f \$(ROOTDIR)/*~ \$(INCDIR)/*~
	@cd \$(SRCDIR); make clean
	-@rm -f \$(LIBDIR)/*.so
	@cd \$(TOOLDIR); make clean
	@cd \$(APPDIR); make clean
	@cd \$(DOCDIR); make clean
	@cd \$(SAMPLEDIR); ./allclean.sh
install:
	@echo " INSTALL	library"
	-@install -m 755 \$(LIBDIR)/*.so \$(PREFIX)/lib/
	@echo " INSTALL	header files"
	-@install -m 755 -d \$(PREFIX)/include/\$(PROJNAME)
	-@install -m 644 \$(INCDIR)/*.h \$(PREFIX)/include/\$(PROJNAME)/
	@echo " INSTALL	tools"; cd \$(TOOLDIR); make install
	@echo " INSTALL	applications"; cd \$(APPDIR); make && make install
uninstall:
	@echo " UNINSTALL	library"
	-@rm \$(PREFIX)/lib/lib\$(PROJNAME).so
	@echo " UNINSTALL	header files"
	-@rm -r \$(PREFIX)/include/\$(PROJNAME)
	@echo " UNINSTALL	tools"; cd \$(TOOLDIR); make uninstall
	@echo " UNINSTALL	applications"; cd \$(APPDIR); make uninstall
EOF
    ;;
esac

exit 0
